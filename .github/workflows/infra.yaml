name: Infrastructure

on:
  pull_request:
    paths:
      - "infra/**"
  push:
    branches: [main]
    paths:
      - "infra/**"

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  opentofu:
    name: OpenTofu Infra Pipeline
    runs-on: ubuntu-latest
    environment: production

    # Environment variables passed to Terraform/OpenTofu
    env:
      TF_VAR_name_prefix: devops-fmi-course-2025
      TF_VAR_project_id: devops-fmi-course-2025
      TF_VAR_region: europe-west4
      TF_VAR_zone: europe-west4-a
      TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
      TF_VAR_github_repository: nikola-enter21/devops

    defaults:
      run:
        working-directory: infra

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to GCP via OIDC
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: "projects/984999448876/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions"
          service_account: github-terraform-deployer@devops-fmi-course-2025.iam.gserviceaccount.com
          token_format: "access_token"
          project_id: devops-fmi-course-2025

      - name: Set up OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: latest

      - name: Initialize OpenTofu
        run: tofu init

      - name: Format check
        run: tofu fmt -check

      - name: Validate configuration
        run: tofu validate

      - name: Plan infrastructure
        run: tofu plan -no-color -out=tfplan > plan.txt

      - name: Post plan to PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planRaw = fs.readFileSync('infra/plan.txt', 'utf8');
            const destroyRegex = /Plan:\s+\d+\s+to add,\s+\d+\s+to change,\s+(\d+)\s+to destroy\./;
            const match = planRaw.match(destroyRegex);

            let warning = '';
            if (match && parseInt(match[1], 10) > 0) {
              warning = '**WARNING: This plan will DESTROY ' + match[1] + ' resource(s)**\n\n';
            }

            const truncatedPlan = planRaw.length > 65000 ? planRaw.substring(0, 65000) + '\n...(truncated)' : planRaw;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### Terraform Plan Output\n\n${warning}\n\`\`\`hcl\n${truncatedPlan}\n\`\`\``
            });

      - name: Apply (main branch only)
        if: github.ref == 'refs/heads/main'
        run: tofu apply -auto-approve tfplan
